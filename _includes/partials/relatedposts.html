{% unless page.categories == null %}
<div class="relatedposts">
<h3>Related Posts</h3>
<ul class="list_of_posts">
   {% assign maxRelated = 4 %}
   {% assign minCommonCategories = 2 %}
   {% assign maxRelatedCounter = 0 %}
   
        {% for post in site.posts %}
            {% assign sameCategories = 0 %}
            {% assign commonCats = '' %}
                
            {% for category in post.categories %}
                    {% if post.url != page.url %}
                        {% if page.categories contains category %}
                            {% assign sameCategories = sameCategories | plus: 1 %}
                            
                            {% capture categorymarkup %}
                             <span class="label label-default">{{category}}</span>
                            {% endcapture %}
                        {% endif %}
                    {% endif %}
            {% endfor %}
        
            {% if sameCategories >= minCommonCategories %}
                {% include /partials/postloop.html %}
                {% assign maxRelatedCounter = maxRelatedCounter | plus: 1 %}
                {% if maxRelatedCounter >= maxRelated %}
                    {% break %}
            {% endif %}
            {% endif %}
        {% endfor %}
        
    </ul>
</div>
{% endunless %}




